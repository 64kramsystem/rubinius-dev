#!/usr/bin/env ruby

require 'optparse'
require 'spec/spec_helper'
require 'mspec/bin/options'

opts = SpecOptions.new "ci", "", 28, "   "
opts.add_formatters
opts.add_action_filters
opts.add_actions
opts.add_verbose
opts.add_help

patterns = opts.parse
opts.config.register

patterns = ENV["CI_FILES"].split if patterns.empty?

files = []
patterns.each do |item|
  stat = File.stat(File.expand_path(item))
  files << item if stat.file?
  files.concat(Dir[item+"/**/*_spec.rb"].sort) if stat.directory?
end

MSpec.register_tags_path ENV["TAGS_DIR"]
MSpec.register_files files
TagFilter.new(:exclude, "fails").register

MSpec.process
exit MSpec.exit_code

#!/usr/bin/env ruby

require 'optparse'
require 'mspec/version'
require 'mspec/bin/options'
require 'mspec/bin/script'


class MSpecScript
  def initialize
    Config[:includes] = []
    Config[:requires] = []
    Config[:target] = 'ruby'
    Config[:flags] = []
    Config[:command] = nil
    Config[:options] = []

    if ["ci", "run", "tag"].include? ARGV[0]
      Config[:command] = ARGV.shift
      Config[:options] << "-h" if ARGV.delete("-h") || ARGV.delete("--help")
    end
  end

  def options(argv=ARGV)
    options = MSpecOptions.new Config, "[COMMAND]", "", 28, "   "

    options.separator ""
    options.separator "  The mspec command sets up and invokes the sub-commands"
    options.separator "  (see below) to enable, for instance, running the specs"
    options.separator "  with different implementations like ruby, jruby, rbx, etc.\n"

    options.add_config do |f|
      Config[:options] << '-B' << f
      config f
    end

    options.on("-t", "--target TARGET", String,
            "Implementation to run the specs: r:ruby|r19:ruby19|x:rbx|j:jruby") do |t|
      case t
      when 'r', 'ruby'
        Config[:target] = 'ruby'
        Config[:flags] << '-v'
      when 'r19', 'ruby19'
        Config[:target] = 'ruby19'
      when 'x', 'rbx', 'rubinius'
        Config[:target] = 'shotgun/rubinius'
      when 'j', 'jruby'
        Config[:target] = 'jruby'
      else
        Config[:target] = t
      end
    end
    options.on("-T", "--target-opt OPT", String,
            "Pass OPT as a flag to the target implementation") do |t|
      Config[:flags] << t
    end
    options.on("-I", "--include DIR", String,
            "Pass DIR through as the -I option to the target") do |d|
      Config[:includes] << "-I#{d}"
    end
    options.on("-r", "--require LIBRARY", String,
            "Pass LIBRARY through as the -r option to the target") do |f|
      Config[:requires] << "-r#{f}"
    end
    options.on("-D", "--gdb", "Run under gdb") do
      Config[:flags] << '--gdb'
    end
    options.on("-A", "--valgrind", "Run under valgrind") do
      Config[:flags] << '--valgrind'
    end
    options.on("-w", "--warnings", "Don't supress warnings") do
      Config[:flags] << '-w'
      ENV['OUTPUT_WARNINGS'] = '1'
    end
    options.on("-v", "--version", "Show version") do
      puts "MSpec #{MSpec::VERSION}"
      exit
    end
    options.on("-h", "--help", <<-EOH) do
Show this message

   where COMMAND is one of:

     run - Run the specified specs (default)
     ci  - Run the known good specs
     tag - Add or remove tags

   mspec COMMAND -h for more options
EOH
      puts options.parser
      exit
    end

    Config[:options] += options.parser.filter! argv
    options.parse
  end

  def register; end

  def run
    ENV['MSPEC_RUNNER'] = '1'

    argv = Config[:flags]
    argv.concat Config[:includes]
    argv.concat Config[:requires]
    argv << "mspec/bin/mspec-#{ Config[:command] || "run" }"
    argv.concat Config[:options]

    exec Config[:target], *argv
  end
end

MSpecScript.main if __FILE__ == $0

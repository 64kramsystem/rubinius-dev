#!/usr/bin/env ruby

require 'akira_bot'
require 'yaml'

class CIBot < AkiraBot
  def ci_poll dir
    known = {}
    seen = {}
    time = config[:time] || 60

    @thread = Thread.new do
      sleep 10 # just to help get IRC logged in
      Dir.chdir dir do
        loop do
          sleep time
          latest = YAML.load_file("html/index.yaml").last rescue next
          p latest[:submitted]
        end
      end
    end
  end
end

dir = ARGV.shift || "/tmp/ci"

cibot = CIBot.new(:channel => 'ruby2c',
                  :name => '#rubinius CI Bot',
                  :time => 120)

cibot.ci_poll dir
cibot.start

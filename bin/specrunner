#!/usr/bin/env bash
# Fear my elite bash skills

SR_GOODFILE="/tmp/mini_spec_specrunner.txt"
SR_ERRFILE="/tmp/mini_spec_specrunner_error.txt"

# Files to run
if [[ -d $1 ]]; then
  SR_SOURCE=`find $1 -name *_spec.rb`
elif [[ -f $1 ]]; then
  SR_SOURCE=$1
else
  echo "Usage: [SR_TARGET=<vm>] specrunner <file|directory>"
  exit 1
fi

# Target VM
if [[ $SR_TARGET = "" ]]; then
  SR_TARGET=shotgun/rubinius
fi

for i in $SR_SOURCE; do 
#  $SR_TARGET -rspec/mini_rspec.rb $i | tee -a > $SR_GOODFILE 2> $SR_ERRFILE
  $SR_TARGET -rspec/mini_rspec.rb $i  >> $SR_GOODFILE 2>> $SR_ERRFILE
done 

cat $SR_GOODFILE
echo ""
echo ""
echo "Errors:"
cat $SR_ERRFILE
echo ""
echo ""
echo ""
echo "$(cat $SR_GOODFILE | grep "^ -" | wc -l) specifications, $(cat $SR_GOODFILE | grep FAILED | wc -l) failures"
echo ""

rm $SR_GOODFILE
rm $SR_ERRFILE

#!/usr/bin/env ruby

require 'benchmark'
include Benchmark

WIDTH = 42

allstart = Time.now

Benchmark.bmbm do |x|
  ['ruby','shotgun/rubinius'].each do |interpreter|
    if interpreter =~ /rubinius/ then
      Dir['test/benchmark/*/bm*.rbc'].each do |file|
        File.unlink file
      end
    end

    Dir['test/benchmark/*/bm*.rb'].each do |file|
      results = []

      file =~ %r{/([^/]+)$}
      prettyfile = $1

      interpreter =~ %r{(ruby|rubinius)}
      prettyint   =  $1

      command = "#{interpreter} #{file}"

      case file
        when /wycats\/bm_string[.]rb/
          command += %{ -x "String#unpack"}
        when /borasky\/bm_MatrixBenchmark[.]rb/
          command += %{ 64}
      end
        
      quiet_command = command + ' > /dev/null 2>&1'

      caption = prettyint + ': ' + prettyfile

      x.report(caption + ' ' * (WIDTH - caption.length)) do
        if not system quiet_command then
          system command
        end
      end
    end
  end
  [Time.now - allstart]
end

---
mnemonic: cast_for_multi_block_arg
operation: >-
  Converts a block argument single-valued tuple into multiple arguments if the arg is an array
format: cast_for_multi_block_arg
opcode: 111
stack_before:
  - tuple[array[el1,el2,...,eln]]
  - ...
stack_after:
  - tuple[el1,el2,...,eln]
  - ...
description: >-
  If the tuple on the top of the stack has only a single element, and that
  element is an array, a new tuple is created containing the contents of the
  array, and this new tuple is used to update the top of the stack.
example: |-
  [[1,2,3]].each do |i,j,k|
    # do something
  end
source: |-
    t1 = stack_top();
    k = NUM_FIELDS(t1);
    /* If there is only one thing in the tuple... */
    if(k == 1) {
      t1 = tuple_at(state, t1, 0);
      /* and that thing is an array... */
      if(RISA(t1, array)) {
        /* make a tuple out of the array contents... */
        j = FIXNUM_TO_INT(array_get_total(t1));
        t2 = tuple_new(state, j);

        for(k = 0; k < j; k++) {
          tuple_put(state, t2, k, array_get(state, t1, k));
        }
        
        /* and put it on the top o the stack. */
        stack_set_top(t2);
      }
    }
